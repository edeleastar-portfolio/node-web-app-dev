

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/css/uikit.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/js/uikit-icons.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"/>
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <style>
    

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



  </style>

  <body class="lab">

    
  <div class="uk-offcanvas-content">
    <div id="offcanvas-usage" uk-offcanvas>
      <div class="uk-offcanvas-bar">
        <button class="uk-offcanvas-close" type="button" uk-close></button>
        <ul class="uk-nav">
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-02-js-review/book-1-javascript-intro/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-2.1 JS Intro
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-02-js-review/book-2-javascript-fundamentals/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-2.2 JS Basics
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-03-jquery+dom/book-3-jquery/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-3 JQuery
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-04-ajax+apis/book-1-ajax-1/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-4.1 Github API
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-04-ajax+apis/book-2-ajax-2/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-4.2-FoureSquare API
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-05-applications/book-applications/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-5 Applications
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-06-views/book-views/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-6 Views
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-07-sessions/book-sessions/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-7 Sessions
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-08-models/book-models/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-8 Models
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-09-validation/book-validation/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-9 Validation
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-10-deployment/book-deployment/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-10 Deployment
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-11-seeding/book-seeding/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-11 Seeding
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-12-api/book-api/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-12 Apis
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-13-security-introduction/book-1-pgp-gpg/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-13 GPG
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-14-security-foundations/book-1-openssl/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-14 OpenSSL and Certificates
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-15-authentication+tls/book-1-tls-configuration/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-15 TLS Configuration
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-16-tdd/book-tdd/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-16 Tdd
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-17-webapp-threats+vulnerabilities/book-1-misuse-cases/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-17 Misuse Cases
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-18-rest/book-rest/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-18 Rest
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-19-web-app-authentication/book-1-web-authentication/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-19 Authentication techniques
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-20-rest-client/book-rest-client/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-19 Java Rest Client
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-21-aurelia-1/book-aurelia-1/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 1
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-22-pentesting/book-1-burp-proxy/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Burp-Proxy
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-22-pentesting/book-2-regex/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Regular Expressions
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-22-pentesting/book-3-xss/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
XSS tips
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-23-aurelia-2/book-aurelia-2/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 2
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-24-aurelia-3/book-aurelia-3/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 3
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-24-aurelia-3/book-aurelia-3-ts/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Aurelia Lab 3 TS
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-25-aurelia-4/book-aurelia-4/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 4
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-25-aurelia-4/book-aurelia-ts-4/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 4 TS
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-26-aurelia-5/book-a-hapi-auth/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Hapi-JWT
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-26-aurelia-5/book-b-aurelia-5/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 5
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-26-aurelia-5/book-b-aurelia-5-ts/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 5 TS
                </a>
              </li>
            
          
        </ul>
      </div>
    </div>
  </div>


    <div uk-sticky>
      <nav class="uk-navbar">
        <div class="uk-navbar-left">
          <ul class="uk-subnav uk-background-secondary uk-subnav-pill">
            <li><a href="#offcanvas-usage" uk-icon="icon: menu" , uk-toggle title="Switch Lab" pos="bottom"
                   uk-tooltip></a></li>
            <li class="uk-active"><a href="../index.html" uk-icon="icon: chevron-up" uk-toggle title="Parent Topic"
                                     pos="bottom" uk-tooltip>11: Model Seeding </a></li>
          </ul>
        </div>
        <div class="uk-navbar-right">
          <ul class="uk-subnav uk-background-secondary uk-subnav-pill"
              uk-switcher="connect: .switcher-container">
            
              <li><a href="#">Lab-11 Seeding</a></li>
            
              <li><a href="#">01</a></li>
            
              <li><a href="#">02</a></li>
            
              <li><a href="#">03</a></li>
            
              <li><a href="#">04</a></li>
            
              <li><a href="#">05</a></li>
            
              <li><a href="#">Exercises</a></li>
            
          </ul>
        </div>
      </nav>
    </div>

    <div class="uk-container uk-container-expand">
      <ul class="uk-switcher switcher-container">
        
          <li> <h1>Objectives</h1>
<p>Include a mongoose seeder component in the application. Use this to validate a new Candidate model, preloading it with a json specified object graph.</p>
</li>
        
          <li> <h1>Mongoose Seeder Utility</h1>
<p>During development it can often aid productivity if we can devise some mechanism for populating our database easily. In particular, this will enable is to pre-load the database on startup, so we can proceed to explore various scenarios without having manually enter a range of sample data.</p>
<p>This component here is a useful approach to this:</p>
<ul>
<li><a href="https://github.com/SamVerschueren/mongoose-seeder">https://github.com/SamVerschueren/mongoose-seeder</a></li>
</ul>
<p>Install the component into your app now:</p>
<pre><code>npm install mongoose-seeder -save</code></pre>
<pre><code>{
  &quot;name&quot;: &quot;donation-web&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;an application to host donations for candidates&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;start&quot;: &quot;node index&quot;,
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;dependencies&quot;: {
    &quot;handlebars&quot;: &quot;^4.0.5&quot;,
    &quot;hapi&quot;: &quot;^14.1.0&quot;,
    &quot;hapi-auth-cookie&quot;: &quot;^6.1.1&quot;,
    &quot;inert&quot;: &quot;^4.0.1&quot;,
    &quot;joi&quot;: &quot;^9.0.4&quot;,
    &quot;mongoose&quot;: &quot;^4.5.8&quot;,
    &quot;mongoose-seeder&quot;: &quot;^1.2.1&quot;,
    &quot;vision&quot;: &quot;^4.1.0&quot;
  }
}</code></pre>
<p>Starting with a sample user + a donation:</p>
<h2>app/models/data.json</h2>
<pre><code>{
  &quot;users&quot;: {
    &quot;_model&quot;: &quot;User&quot;,
    &quot;homer&quot;: {
      &quot;firstName&quot;: &quot;Homer&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    }
  },
  &quot;donations&quot;: {
    &quot;_model&quot;: &quot;Donation&quot;,
    &quot;one&quot;: {
      &quot;amount&quot;: 40,
      &quot;method&quot;: &quot;paypal&quot;,
      &quot;donor&quot;: &quot;-&gt;users.homer&quot;
    }
  }
}</code></pre>
<p>Note how the relationship between a user and a donation is represented as <code>-&gt;users.homer</code> in this example.</p>
<p>We can load this is <code>db.js</code>:</p>
<h2>app/models/db.js</h2>
<pre><code>mongoose.connection.on(&#39;connected&#39;, function () {
  console.log(&#39;Mongoose connected to &#39; + dbURI);
  if (process.env.NODE_ENV != &#39;production&#39;) {
    var seeder = require(&#39;mongoose-seeder&#39;);
    const data = require(&#39;./data.json&#39;);
    const Donation = require(&#39;./donation&#39;);
    const User = require(&#39;./user&#39;);
    seeder.seed(data, { dropDatabase: false, dropCollections: true }).then(dbData =&gt; {
      console.log(&#39;preloading Test Data&#39;);
      console.log(dbData);
    }).catch(err =&gt; {
      console.log(error);
    });
  }
});</code></pre>
<p>Try this now. When you restart the app (running locally, not in production), it will delete the contents of the database and then populate with the two objects. Verify that the users and donations collections are as specified in the json file above.</p>
<p>We are logging the preloaded objects in the console:</p>
<pre><code>preloading Test Data
{ users: 
   { homer: 
      { __v: 0,
        firstName: &#39;Homer&#39;,
        lastName: &#39;Simpson&#39;,
        email: &#39;homer@simpson.com&#39;,
        password: &#39;secret&#39;,
        _id: 57a738e1edbdf4a41777d25b } },
  donations: 
   { one: 
      { __v: 0,
        amount: 40,
        method: &#39;paypal&#39;,
        donor: 57a738e1edbdf4a41777d25b,
        _id: 57a738e1edbdf4a41777d25c } } }</code></pre>
</li>
        
          <li> <h1>More Preloaded Objects</h1>
<p>A more extensive set of objects:</p>
<h2>app/models/data.json</h2>
<pre><code>{
  &quot;users&quot;: {
    &quot;_model&quot;: &quot;User&quot;,
    &quot;homer&quot;: {
      &quot;firstName&quot;: &quot;Homer&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    &quot;marge&quot;: {
      &quot;firstName&quot;: &quot;Marge&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    &quot;bart&quot;: {
      &quot;firstName&quot;: &quot;Bart&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;bart@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    }
  },
  &quot;donations&quot;: {
    &quot;_model&quot;: &quot;Donation&quot;,
    &quot;one&quot;: {
      &quot;amount&quot;: 40,
      &quot;method&quot;: &quot;paypal&quot;,
      &quot;donor&quot;: &quot;-&gt;users.bart&quot;
    },
    &quot;two&quot;: {
      &quot;amount&quot;: 90,
      &quot;method&quot;: &quot;direct&quot;,
      &quot;donor&quot;: &quot;-&gt;users.marge&quot;
    },
    &quot;three&quot;: {
      &quot;amount&quot;: 430,
      &quot;method&quot;: &quot;paypal&quot;,
      &quot;donor&quot;: &quot;-&gt;users.homer&quot;
    }
  }
}</code></pre>
<p>The position of the commas is very important here - as they are separators, not terminators. Try adding an extra comma after the last user object to get a feel for how the app will respond.</p>
</li>
        
          <li> <h1>Introduce and Seed Candidate Model</h1>
<p>With this seeding infrastructure in place, we can extend the application model more easily. First, we will introduce a new schema to represent a <code>Candidate</code> in our app:</p>
<h2>app/models/candidate.js</h2>
<pre><code>&#39;use strict&#39;;

const mongoose = require(&#39;mongoose&#39;);

const candidateSchema = mongoose.Schema({
  firstName: String,
  lastName: String,
  office: String,
});

const Candidate = mongoose.model(&#39;Candidate&#39;, candidateSchema);
module.exports = Candidate;</code></pre>
<p>Donations must reference the candidate the donation is intended for. We already reference the donor, so we extend the schema to refer to the candidate:</p>
<h2>app/models/donation.js</h2>
<pre><code>const donationSchema = mongoose.Schema({
  amount: Number,
  method: String,
  donor: {
    type: mongoose.Schema.Types.ObjectId,
    ref: &#39;User&#39;,
  },
  candidate:  {
    type: mongoose.Schema.Types.ObjectId,
    ref: &#39;Candidate&#39;,
  },
});</code></pre>
<p>When we define a new model, we must load it before attempting to seed the database:</p>
<h2>app/models/db.js</h2>
<pre><code>...
    const Donation = require(&#39;./donation&#39;);
    const User = require(&#39;./user&#39;);
    const Candidate = require(&#39;./candidate.js&#39;);
    seeder.seed(data, { dropDatabase: false, dropCollections: true }).then(dbData =&gt; {
      console.log(&#39;preloading Test Data&#39;);
      console.log(dbData);
...</code></pre>
<p>We can now seed this extended model:</p>
<h2>app/models/data.json</h2>
<pre><code>{
  &quot;users&quot;: {
    &quot;_model&quot;: &quot;User&quot;,
    &quot;homer&quot;: {
      &quot;firstName&quot;: &quot;Homer&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;homer@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    &quot;marge&quot;: {
      &quot;firstName&quot;: &quot;Marge&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;marge@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    },
    &quot;bart&quot;: {
      &quot;firstName&quot;: &quot;Bart&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;email&quot;: &quot;bart@simpson.com&quot;,
      &quot;password&quot;: &quot;secret&quot;
    }
  },
  &quot;candidates&quot;: {
    &quot;_model&quot;: &quot;Candidate&quot;,
    &quot;lisa&quot;: {
      &quot;firstName&quot;: &quot;Lisa&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;office&quot;: &quot;President&quot;
    },
    &quot;donald&quot;: {
      &quot;firstName&quot;: &quot;Donald&quot;,
      &quot;lastName&quot;: &quot;Simpson&quot;,
      &quot;office&quot;: &quot;President&quot;
    }
  },
  &quot;donations&quot;: {
    &quot;_model&quot;: &quot;Donation&quot;,
    &quot;one&quot;: {
      &quot;amount&quot;: 40,
      &quot;method&quot;: &quot;paypal&quot;,
      &quot;donor&quot;: &quot;-&gt;users.bart&quot;,
      &quot;candidate&quot;: &quot;-&gt;candidates.lisa&quot;
    },
    &quot;two&quot;: {
      &quot;amount&quot;: 90,
      &quot;method&quot;: &quot;direct&quot;,
      &quot;donor&quot;: &quot;-&gt;users.marge&quot;,
      &quot;candidate&quot;: &quot;-&gt;candidates.lisa&quot;
    },
    &quot;three&quot;: {
      &quot;amount&quot;: 430,
      &quot;method&quot;: &quot;paypal&quot;,
      &quot;donor&quot;: &quot;-&gt;users.homer&quot;,
      &quot;candidate&quot;: &quot;-&gt;candidates.donald&quot;
    }
  }
}</code></pre>
</li>
        
          <li> <h1>Create Candidate Reference in Donation Object</h1>
<p>One the home view, we should pass the list of candidates to the view to enable the user to select which candidate to make a donation to:</p>
<h2>app/controllers/donations.js</h2>
<pre><code>const Candidate = require(&#39;../models/candidate&#39;);
...</code></pre>
<pre><code>exports.home = {

  handler: function (request, reply) {
    Candidate.find({}).then(candidates =&gt; {
      reply.view(&#39;home&#39;, {
        title: &#39;Make a Donation&#39;,
        candidates: candidates,
      });
    }).catch(err =&gt; {
      reply.redirect(&#39;/&#39;);
    });
  },

};</code></pre>
<p>In the donate partial = we can present the candidate list as a radio button sequence:</p>
<h2>app/views/partials/donate.hbs</h2>
<pre><code>&lt;div class=&quot;grouped inline fields&quot;&gt;
  &lt;h3&gt; Select Candidate &lt;/h3&gt;
  {{#each candidates }}
    &lt;div class=&quot;field&quot;&gt;
      &lt;div class=&quot;ui radio checkbox&quot;&gt;
        &lt;input type=&quot;radio&quot; name=&quot;candidate&quot; value=&quot;{{lastName}},{{firstName}}&quot;&gt;
        &lt;label&gt;{{lastName}}, {{firstName}}&lt;/label&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  {{/each}}
&lt;/div&gt;
&lt;button class=&quot;ui blue submit button&quot;&gt;Donate&lt;/button&gt;</code></pre>
<p>Creating a donation is more complex, as we have to locate the current user in the database, also locate the preferred candidate. Only when these two queries are performed can we create and insert a new donation object:</p>
<h2>app/controllers/donations.js</h2>
<pre><code>exports.donate = {

  handler: function (request, reply) {
    var userEmail = request.auth.credentials.loggedInUser;
    User.findOne({ email: userEmail }).then(user =&gt; {
      let data = request.payload;
      const donation = new Donation(data);
      const rawCandidate = request.payload.candidate.split(&#39;,&#39;);
      Candidate.findOne({
        lastName: rawCandidate[0],
        firstName: rawCandidate[1],
      }).then(candidate =&gt; {
        donation.donor = user._id;
        donation.candidate = candidate._id;
        donation.save().then(newDonation =&gt; {
          reply.redirect(&#39;/report&#39;);
        });
      }).catch(err =&gt; {
        reply.redirect(&#39;/&#39;);
      });
    }).catch(err =&gt; {
      reply.redirect(&#39;/&#39;);
    });
  },
};</code></pre>
<p>Her is an alternative, less heavily nested version:</p>
<pre><code>exports.donate = {

  handler: function (request, reply) {
    var userEmail = request.auth.credentials.loggedInUser;
    let userId = null;
    let donation = null;
    User.findOne({ email: userEmail }).then(user =&gt; {
      let data = request.payload;
      userId = user._id;
      donation = new Donation(data);
      const rawCandidate = request.payload.candidate.split(&#39;,&#39;);
      return Candidate.findOne({ lastName: rawCandidate[0], firstName: rawCandidate[1] });
    }).then(candidate =&gt; {
      donation.donor = userId;
      donation.candidate = candidate._id;
      return donation.save();
    }).then(newDonation =&gt; {
      reply.redirect(&#39;/report&#39;);
    }).catch(err =&gt; {
      reply.redirect(&#39;/&#39;);
    });
  },
};</code></pre>
<p>Compare the above to versions, paying close attention to how the scoping rules operate, requiring additional temporary variables. However, the second version has simpler error handling.</p>
</li>
        
          <li> <h1>Render Candidates in Report View</h1>
<p>The donationList partial will need an extra column to hold the candidate:</p>
<h2>app/views/partials/donationlist.hbs</h2>
<pre><code>&lt;thead&gt;
  &lt;tr&gt;
    &lt;th&gt;Amount&lt;/th&gt;
    &lt;th&gt;Method donated&lt;/th&gt;
    &lt;th&gt;Donor&lt;/th&gt;
    &lt;th&gt;Candidate&lt;/th&gt;
  &lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
  {{#each donations}}
    &lt;tr&gt;
      &lt;td&gt; {{amount}} &lt;/td&gt;
      &lt;td&gt; {{method}} &lt;/td&gt;
      &lt;td&gt; {{donor.firstName}} {{donor.lastName}} &lt;/td&gt;
      &lt;td&gt; {{candidate.lastName}}, {{candidate.firstName}} &lt;/td&gt;
    &lt;/tr&gt;
  {{/each}}</code></pre>
<p>Finally, the report handler will need to populate the <code>canddiate</code> field in the database:</p>
<h2>app/controllers/donation.js</h2>
<pre><code>exports.report = {

  handler: function (request, reply) {
    Donation.find({}).populate(&#39;donor&#39;).populate(&#39;candidate&#39;).then(allDonations =&gt; {
      reply.view(&#39;report&#39;, {
        title: &#39;Donations to Date&#39;,
        donations: allDonations,
      });
    }).catch(err =&gt; {
      reply.redirect(&#39;/&#39;);
    });
  },

};</code></pre>
<p>This should work now as expected.</p>
</li>
        
          <li> <h1>Exercises</h1>
<p>Archive of the project so far:</p>
<ul>
<li><a href="https://bitbucket.org/edeleastar/donation-web-10/commits/all">https://bitbucket.org/edeleastar/donation-web-10/commits/all</a></li>
</ul>
<h2>Exercise 1:</h2>
<p>Change the donate screen such that users can donate any amount and not just 50, 100, 1000 multiples. For example:</p>
<p><img src="img/01.png" alt=""></p>
<h2>Exercise 2:</h2>
<p>Modify the report view to display total donated so far:</p>
<p><img src="img/02.png" alt=""></p>
<h2>Exercise 3:</h2>
<p>Incorporate validation into the donate view:</p>
<p><img src="img/03.png" alt=""></p>
</li>
        
      </ul>
    </div>

    <script>
      $(document).ready(function() {
  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass('');
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass('uk-label uk-text-lowercase');
      divLabel.append($images[i].alt);
      $(divLabel).insertAfter($images[i]);
      $('<br>').insertAfter($images[i]);
    }
  });
});

    </script>
  </body>
</html>