

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/css/uikit.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/js/uikit.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/uikit/3.0.0-rc.6/js/uikit-icons.min.js"></script>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"/>
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <style>
    

body {
  font-family: "Open Sans", "Helvetica", "Helvetica Neue",  "Arial", sans-serif;
  font-size:90%;
  color: black;
}

p {
  margin: 0.5em;
}

pre code {
  font-family: "Monaco";
  font-size: 100%;
}

img {
  box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);
  margin:10px;
}

h1, h2, h3 {
  border-bottom:thin solid black;
  margin-bottom: 0.5em;
  margin-top: 1em;
}

h1 {
  font-style:italic;
  font-size:130%;
}

h2 {
  font-size:110%;
}

h3 {
  font-size:100%;
}



  </style>

  <body class="lab">

    
  <div class="uk-offcanvas-content">
    <div id="offcanvas-usage" uk-offcanvas>
      <div class="uk-offcanvas-bar">
        <button class="uk-offcanvas-close" type="button" uk-close></button>
        <ul class="uk-nav">
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-02-js-review/book-1-javascript-intro/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-2.1 JS Intro
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-02-js-review/book-2-javascript-fundamentals/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-2.2 JS Basics
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-03-jquery+dom/book-3-jquery/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-3 JQuery
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-04-ajax+apis/book-1-ajax-1/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-4.1 Github API
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-04-ajax+apis/book-2-ajax-2/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-4.2-FoureSquare API
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-05-applications/book-applications/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-5 Applications
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-06-views/book-views/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-6 Views
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-07-sessions/book-sessions/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-7 Sessions
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-08-models/book-models/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-8 Models
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-09-validation/book-validation/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-9 Validation
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-10-deployment/book-deployment/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-10 Deployment
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-11-seeding/book-seeding/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-11 Seeding
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-12-api/book-api/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-12 Apis
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-13-security-introduction/book-1-pgp-gpg/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-13 GPG
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-14-security-foundations/book-1-openssl/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-14 OpenSSL and Certificates
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-15-authentication+tls/book-1-tls-configuration/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-15 TLS Configuration
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-16-tdd/book-tdd/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-16 Tdd
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-17-webapp-threats+vulnerabilities/book-1-misuse-cases/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-17 Misuse Cases
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-18-rest/book-rest/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-18 Rest
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-19-web-app-authentication/book-1-web-authentication/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-19 Authentication techniques
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-20-rest-client/book-rest-client/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-19 Java Rest Client
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-21-aurelia-1/book-aurelia-1/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 1
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-22-pentesting/book-1-burp-proxy/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Burp-Proxy
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-22-pentesting/book-2-regex/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Regular Expressions
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-22-pentesting/book-3-xss/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
XSS tips
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-23-aurelia-2/book-aurelia-2/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 2
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-24-aurelia-3/book-aurelia-3/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 3
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-24-aurelia-3/book-aurelia-3-ts/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Aurelia Lab 3 TS
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-25-aurelia-4/book-aurelia-4/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 4
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-25-aurelia-4/book-aurelia-ts-4/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 4 TS
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-26-aurelia-5/book-a-hapi-auth/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Hapi-JWT
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-26-aurelia-5/book-b-aurelia-5/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 5
                </a>
              </li>
            
          
            
              <li>
                <a class="item" href="https://edeleastar-portfolio.github.io//node-web-app-dev//topic-26-aurelia-5/book-b-aurelia-5-ts/index.html">
  <i class="fas fa-flask " style="color:#00BCD4"> </i>
Lab-Aurelia 5 TS
                </a>
              </li>
            
          
        </ul>
      </div>
    </div>
  </div>


    <div uk-sticky>
      <nav class="uk-navbar">
        <div class="uk-navbar-left">
          <ul class="uk-subnav uk-background-secondary uk-subnav-pill">
            <li><a href="#offcanvas-usage" uk-icon="icon: menu" , uk-toggle title="Switch Lab" pos="bottom"
                   uk-tooltip></a></li>
            <li class="uk-active"><a href="../index.html" uk-icon="icon: chevron-up" uk-toggle title="Parent Topic"
                                     pos="bottom" uk-tooltip>26: Aurelia/Hapi JWT </a></li>
          </ul>
        </div>
        <div class="uk-navbar-right">
          <ul class="uk-subnav uk-background-secondary uk-subnav-pill"
              uk-switcher="connect: .switcher-container">
            
              <li><a href="#">Lab-Aurelia 5 TS</a></li>
            
              <li><a href="#">Exercise Solutions</a></li>
            
              <li><a href="#">02</a></li>
            
              <li><a href="#">03</a></li>
            
              <li><a href="#">04</a></li>
            
              <li><a href="#">05</a></li>
            
              <li><a href="#">06.Exercises</a></li>
            
          </ul>
        </div>
      </nav>
    </div>

    <div class="uk-container uk-container-expand">
      <ul class="uk-switcher switcher-container">
        
          <li> <h1>Objectives</h1>
<p>Assuming our donation-web app api has been secured with JWT tokens, revised donation-service classes to authenticate against and use these secure routes.</p>
</li>
        
          <li> <h1>Lab Aurelia 4 Exercises</h1>
<h2>Exercise 1: Retrieve prior donations</h2>
<p>When you first log in, modify app such that existing donations are retrieved from donation-web. Currently we only show donations made my the current user.</p>
<h2>src/services/donation-service.js</h2>
<pre><code>  ...
  constructor(data, ea, ac) {
    ...
    this.getDonations();
  }

  getDonations() {
    this.ac.get(&#39;/api/donations&#39;).then(res =&gt; {
      this.donations = res.content;
    });
  }
...

Note: this solution will be invalidated by our forthcoming approach to authenticated routes, and will need to be changed later.</code></pre>
<h1>Exercise 2: Show Candidate names in report</h1>
<p>Notice that, when you make a donation - the actual candidate&#39;s name does not appear. Why is this? In chrome, debug into the app to explore why. See if you can fix this. </p>
<p>There are two approaches:</p>
<ul>
<li>You already know the candidate name in the donation-client, so just insert it into the donation.</li>
<li>Change donation-web to populate the donation&#39;s candidate field when you create a donation.</li>
</ul>
<h2>Solution</h2>
<p>This is a modification of the donation-web api for creating donations:</p>
<pre><code>exports.makeDonation = {

  auth: false,

  handler: function (request, reply) {
    const donation = new Donation(request.payload);
    donation.candidate = request.params.id;
    donation.save().then(newDonation =&gt; {
      Donation.findOne(newDonation).populate(&#39;candidate&#39;).then(donation =&gt; {
        reply(donation).code(201);
      });
    }).catch(err =&gt; {
      reply(Boom.badImplementation(&#39;error making donation&#39;));
    });
  },

};</code></pre>
<p>When a donation is created, it populates the candidate field. No further modification should be neccessary.</p>
</li>
        
          <li> <h1>async-http-client</h1>
<p>You must be running the jwt enabled version of the donation-web service to test these additions.</p>
<p>This is a sophisticated change to the AsyncHttpClient class, but implemented in very concise code. </p>
<h2>src/donation-service/async-http-client.js</h2>
<p>First, change the constructor in import the EventAggregator:</p>
<h2>src/services/async-http-client.js</h2>
<pre><code>import { inject } from &#39;aurelia-framework&#39;;
import { HttpClient } from &#39;aurelia-http-client&#39;;
import Fixtures from &#39;./fixtures&#39;;
import { EventAggregator } from &#39;aurelia-event-aggregator&#39;;
import { LoginStatus } from &#39;./messages&#39;;
import { User } from &#39;./models&#39;;

@inject(HttpClient, Fixtures, EventAggregator)
export default class AsyncHttpClient {
  http: HttpClient;
  ea: EventAggregator;

  constructor(httpClient, fixtures, ea) {
    this.http = httpClient;
    this.http.configure(http =&gt; {
      http.withBaseUrl(fixtures.baseUrl);
    });
    this.ea = ea;
  }
...</code></pre>
<p>Now introduce a new method to authenticate a user to the api:</p>
<h2>src/services/async-http-client.js</h2>
<pre><code>  authenticate(url: string, credentials: {email:string, password:string}) {
    this.http
      .post(url, credentials)
      .then(response =&gt; {
        const status = response.content;
        if (status.success) {
          this.http.configure(configuration =&gt; {
            configuration.withHeader(
              &#39;Authorization&#39;,
              &#39;bearer &#39; + response.content.token,
            );
          });
        }
        this.ea.publish(new LoginStatus(true));
      })
      .catch(error =&gt; {
        this.ea.publish(new LoginStatus(false, &#39;service not available&#39;));
      });
  }</code></pre>
<p>In the above (invoked in the next step from donation-service), will post to an authenticate url - and if successful, attaches the returned token to all subsequent invocations. It will also store the token in local storage in case our app is suspended. However, we are not really making use of this yet.</p>
<p>An accompanying clear method:</p>
<h2>src/services/async-http-client.js</h2>
<pre><code>  clearAuthentication() {
    this.http.configure(configuration =&gt; {
      configuration.withHeader(&#39;Authorization&#39;, &#39;&#39;);
    });
  }</code></pre>
</li>
        
          <li> <h1>donation-service login/logout</h1>
<p>DonationService can now have its login/logout methods use the new methods.</p>
<p>First, remove retrieval of users and donations in the constructor:</p>
<h2>src/services/donation-service.js</h2>
<pre><code>  constructor(data, ea, ac) {
    this.methods = data.methods;
    this.ea = ea;
    this.ac = ac;
    this.getCandidates();
  }</code></pre>
<p>the users and candidates are protected routes, and will fail if we attempt to read them if we are not authenticated.</p>
<p>Now we can implement login/logout - which are considerably simplified:</p>
<h2>src/services/donation-service.js</h2>
<pre><code>  login(email, password) {
    const user = {
      email: email,
      password: password
    };
    this.ac.authenticate(&#39;/api/users/authenticate&#39;, user);
  }</code></pre>
<pre><code>  logout() {
    this.ac.clearAuthentication();
    this.ea.publish(new LoginStatus(false));
  }</code></pre>
<p>Try this now and see if it works as expected. In particular make sure you can successfully access protected routes.</p>
</li>
        
          <li> <h1>Storing Tokens</h1>
<p>We can save the tokens in <code>Local Storage</code> (in the browser), which might be useful in certain circumstances.</p>
<p>In the authenticate method in <code>AsyncHttpClient</code> we can store the token:</p>
<h2>src/services/async-http-client.js</h2>
<pre><code> authenticate(url, user) {
    ...
        if (status.success) {
          localStorage.donation = JSON.stringify(response.content);
          this.http.configure(configuration =&gt; {
            configuration.withHeader(
              &#39;Authorization&#39;,
              &#39;bearer &#39; + response.content.token,
            );
          });
    ...
    ...
  }</code></pre>
<p>This stores the token in the key <code>donation</code>. We can inspect this in the browser developer tools:</p>
<p><img src="img/01.png" alt=""></p>
<p>We should takes steps to explicitly clear the token from local storage in our <code>clearAuthentication()</code> method:</p>
<h2>src/services/async-http-client.js</h2>
<pre><code>  clearAuthentication() {
    localStorage.donation = null;
    this.http.configure(configuration =&gt; {
      configuration.withHeader(&#39;Authorization&#39;, &#39;&#39;);
    });
  }</code></pre>
<p>Try the following experiment. Log in to the service - and then exit the browser (without logging out). Open the browser again - and see if the token is still in local storage.</p>
<p><img src="img/01.png" alt=""></p>
<p>Because it should be - we can adapt the app to bypass the login screen in this situation (next step).</p>
</li>
        
          <li> <h1>Retrieving Tokens</h1>
<p>We can then introduce a new method in <code>AsyncHttpClient</code> which can recover this token (if present), and install it in our default request headers for subsequent api access:</p>
<h2>src/services/async-http-client.js</h2>
<pre><code>  isAuthenticated() {
    let authenticated = false;
    if (localStorage.donation !== &#39;null&#39;) {
      authenticated = true;
      this.http.configure(http =&gt; {
        const auth = JSON.parse(localStorage.donation);
        http.withHeader(&#39;Authorization&#39;, &#39;bearer &#39; + auth.token);
      });
    }
    return authenticated;
  }</code></pre>
<p>This also returns true if it found a token. </p>
<p>We introduce an accessor for this method in DonationService`:</p>
<h2>src/services/donation-service.js</h2>
<pre><code>  isAuthenticated() {
    return this.ac.isAuthenticated();
  }</code></pre>
<p>This can be enable access to this facility from other components that can only see <code>DonationService</code>.</p>
<p>Finally, if the token is found, we need to switch to the <code>home</code> router then the app launches.</p>
<p>First, in the <code>App</code> class, change the constructor to the following:</p>
<h2>src/spp.js</h2>
<pre><code>
@inject(Aurelia, EventAggregator, DonationService)
export class App {
  router: Router;
  ds: DonationService;

  constructor(au: Aurelia, ea: EventAggregator, ds: DonationService) {
    this.ds = ds;
    ea.subscribe(LoginStatus, msg =&gt; {
      this.router.navigate(&#39;/&#39;, { replace: true, trigger: false });
      this.router.reset();
      if (msg.status === true) {
        au.setRoot(&#39;home&#39;);
      } else {
        au.setRoot(&#39;app&#39;);
      }
    });
  }

...</code></pre>
<p>The only major change in the above is that we are injecting a dependency on DonationService.</p>
<p>Also in the App class, introduce the following function:</p>
<pre><code>  attached() {
    if (this.ds.isAuthenticated()) {
      this.au.setRoot(&#39;home&#39;).then(() =&gt; {
        this.router.navigateToRoute(&#39;dashboard&#39;);
      });
    }
  }</code></pre>
<p>This makes use of the DonationService to determine if the token is available in local storage. If it is, we load the <code>Home</code> router.</p>
</li>
        
          <li> <p>Archive of the lab so far:</p>
<ul>
<li><a href="https://github.com/edeleastar/donation-client-ts/releases/tag/aurelia.lab.5.end">https://github.com/edeleastar/donation-client-ts/releases/tag/aurelia.lab.5.end</a></li>
</ul>
<h2>Exercise 1:</h2>
<p>Deploy the donation-web &amp; donation-client apps. There are two potential scenarios:</p>
<ul>
<li>Deploy donation-web to heroku, and donation-client to github - gh-pages - as outlined in an earlier lab</li>
<li>Deploy both apps to heroku, coping <code>index.html</code> + <code>scripts</code> to the public folder of the donation-web app</li>
</ul>
<p>Make sure that <code>src/sercices/fixtures.js</code> contains the correct url in each instance.</p>
<h2>Learning Resources</h2>
<p>If you are continuing your journey with Aurelia, these resources may be useful:</p>
<p>One of he best books on the framework:</p>
<ul>
<li><a href="https://www.manning.com/books/aurelia-in-action">https://www.manning.com/books/aurelia-in-action</a></li>
</ul>
<p>The starting point for all things Aurelia:</p>
<ul>
<li><a href="http://aurelia.io/docs">http://aurelia.io/docs</a></li>
</ul>
<p>In particular this tutorial:</p>
<ul>
<li><a href="http://aurelia.io/docs/tutorials/creating-a-contact-manager">http://aurelia.io/docs/tutorials/creating-a-contact-manager</a></li>
</ul>
<p>This video here is a useful overview + background:</p>
<ul>
<li><a href="https://vimeo.com/153090562">https://vimeo.com/153090562</a></li>
</ul>
<p>If you would like a holistic view of ESNext - this video here from the same presenter:</p>
<ul>
<li><a href="https://vimeo.com/131191237">https://vimeo.com/131191237</a></li>
</ul>
</li>
        
      </ul>
    </div>

    <script>
      $(document).ready(function() {
  const $images = $('.lab img');
  jQuery.each($images, function(i) {
    if ($images[i].alt.length > 0) {
      const divImg = $(document.createElement('div')).addClass('');
      $($images[i]).wrap(divImg);
      const divLabel = $(document.createElement('div')).addClass('uk-label uk-text-lowercase');
      divLabel.append($images[i].alt);
      $(divLabel).insertAfter($images[i]);
      $('<br>').insertAfter($images[i]);
    }
  });
});

    </script>
  </body>
</html>